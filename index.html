<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»æ°—è¨­è¨ˆãƒã‚¹ã‚¿ãƒ¼ãƒ»ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã€å®Œå…¨çµ±åˆç‰ˆã€‘</title>
    <style>
        :root { 
            --primary: #0f172a; --accent: #2563eb; --danger: #e11d48; 
            --warning: #f59e0b; --success: #10b981; --bg: #f8fafc; 
            --ground: #16a34a; --spec-bg: #f1f5f9;
        }
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; font-size: 13px; line-height: 1.4; }
        .container { max-width: 1600px; margin: auto; display: grid; grid-template-columns: 550px 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; height: fit-content; }
        
        .tab-bar { max-width: 1600px; margin: 0 auto 10px auto; display: flex; gap: 5px; }
        .tab-btn { padding: 12px 24px; border: 1px solid #e2e8f0; border-bottom: none; background: #e2e8f0; border-radius: 12px 12px 0 0; cursor: pointer; font-weight: bold; color: #64748b; transition: 0.3s; }
        .tab-btn.active { background: white; color: var(--accent); border-top: 3px solid var(--accent); }

        h1 { font-size: 1.2rem; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px; color: var(--primary); border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }
        h2 { font-size: 0.8rem; margin: 15px 0 8px 0; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-left: 3px solid var(--accent); padding-left: 8px; }
        
        .input-group { background: #f1f5f9; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { display: block; font-size: 0.7rem; font-weight: 700; margin-bottom: 4px; color: #475569; }
        select, input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-size: 0.9rem; }

        .mode-selector { display: flex; gap: 2px; background: #e2e8f0; padding: 2px; border-radius: 6px; margin-bottom: 8px; }
        .mode-btn { flex: 1; border: none; background: none; padding: 6px; cursor: pointer; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .mode-btn.active { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: var(--accent); }

        .status-banner { padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; font-size: 1.1rem; margin-bottom: 20px; border: 2px solid transparent; }
        .safe { background: #ecfdf5; color: var(--success); border-color: var(--success); }
        .warn { background: #fffbeb; color: var(--warning); border-color: var(--warning); }
        .danger { background: #fff1f2; color: var(--danger); border-color: var(--danger); }

        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #fff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 10px; position: relative; overflow: hidden; }
        .stat-card::before { content: ""; position: absolute; left: 0; top: 0; height: 100%; width: 4px; background: var(--accent); }
        .stat-card.fill::before { background: #8b5cf6; }
        .stat-card.ground::before { background: var(--ground); }
        .stat-value { font-size: 1.4rem; font-weight: 800; display: block; color: var(--primary); margin-bottom: 4px; }
        .stat-label { font-size: 0.7rem; color: #64748b; font-weight: bold; }

        .formula-box { font-family: 'Courier New', Courier, monospace; background: #2d3436; color: #dfe6e9; padding: 12px; border-radius: 8px; font-size: 0.8rem; line-height: 1.6; margin-top: 10px; }
        table.spec-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-bottom: 20px; }
        table.spec-table th, table.spec-table td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
        table.spec-table th { background: #f8fafc; font-weight: bold; color: var(--primary); }

        .btn-print { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }

        @media print {
            .tab-bar, .card:first-child, .btn-print, .spec-container { display: none !important; }
            #calc-view { display: block !important; }
            .container { display: block; }
        }
    </style>
</head>
<body>

<div class="tab-bar">
    <button class="tab-btn active" id="tab-branch" onclick="switchTab('branch')">âš¡ è¨­è¨ˆè¨ˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</button>
    <button class="tab-btn" id="tab-spec" onclick="switchTab('spec')">ğŸ“š JISãƒ»å†…ç·šè¦ç¨‹ãƒ»ä»•æ§˜è§£èª¬</button>
</div>

<div id="calc-view" class="container">
    <div class="card">
        <h1>âš™ï¸ è¨­è¨ˆæ¡ä»¶è¨­å®š</h1>
        
        <h2>1. é›»æºãƒ»è² è·æ¡ä»¶</h2>
        <div class="input-group">
            <label>é…ç·šæ–¹å¼</label>
            <select id="sys-type" onchange="calculate()"></select>
            
            <div id="demand-box" style="margin-top:10px; display:none;">
                <label>éœ€è¦ç‡ : <span id="val-demand">80</span>%</label>
                <input type="range" id="demand-rate" min="10" max="100" step="5" value="80" oninput="calculate()">
            </div>

            <div class="grid-2" style="margin-top:10px;">
                <div>
                    <label>å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</label>
                    <div class="mode-selector">
                        <button class="mode-btn" id="btn-W" onclick="setMode('W')">W</button>
                        <button class="mode-btn active" id="btn-kW" onclick="setMode('kW')">kW</button>
                        <button class="mode-btn" id="btn-A" onclick="setMode('A')">A</button>
                    </div>
                </div>
                <div>
                    <label>è² è·å€¤</label>
                    <input type="number" id="main-input" value="1.5" step="0.1" oninput="calculate()">
                </div>
            </div>
            <label style="margin-top:10px;">åŠ›ç‡ (cos Ï†) : <span id="val-pf">100</span>%</label>
            <input type="range" id="pf-percent" min="50" max="100" step="1" value="100" oninput="calculate()">
        </div>

        <h2>2. é›»ç·šè¨­è¨ˆ</h2>
        <div class="input-group">
            <label>é›»ç·šç¨®åˆ¥ (ã‚¨ã‚³åç§°ä½µè¨˜)</label>
            <select id="wire-cat" onchange="updateSizes()"></select>
            
            <div class="grid-2" style="margin-top:8px;">
                <div>
                    <label>ã‚µã‚¤ã‚º (1.6mmã€œ325SQ)</label>
                    <select id="wire-size" onchange="calculate()"></select>
                </div>
                <div>
                    <label>ä¸¦åˆ—æœ¬æ•° (ä½æ¸›ä¿‚æ•°0.88)</label>
                    <select id="parallel-n" onchange="calculate()">
                        <option value="1">1 (å˜ç‹¬)</option>
                        <option value="2">2æœ¬ä¸¦åˆ—</option>
                        <option value="3">3æœ¬ä¸¦åˆ—</option>
                        <option value="4">4æœ¬ä¸¦åˆ—</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top:10px;">
                <label>é…ç·šé•· (m) : <span id="val-length" style="color:var(--accent)">20</span>m</label>
                <input type="range" id="length-range" min="1" max="500" value="20" oninput="syncLength(this.value, 'range')">
                <input type="number" id="length-num" min="1" max="500" value="20" style="margin-top:5px;" oninput="syncLength(this.value, 'num')">
            </div>
        </div>

        <h2>3. æ–½å·¥ç’°å¢ƒãƒ»é…ç®¡é¸å®š</h2>
        <div class="input-group">
            <div class="grid-2">
                <div>
                    <label>å‘¨å›²æ¸©åº¦ (â„ƒ)</label>
                    <select id="temp" onchange="calculate()">
                        <option value="30">30â„ƒä»¥ä¸‹ (1.0)</option>
                        <option value="40" selected>40â„ƒ (0.82)</option>
                        <option value="50">50â„ƒ (0.58)</option>
                    </select>
                </div>
                <div>
                    <label>æŸç·šæ¸›å°‘ä¿‚æ•°</label>
                    <select id="bundle" onchange="calculate()">
                        <option value="1">1 (å˜ç‹¬: 1.0)</option>
                        <option value="3">2ã€œ3æœ¬ (0.7)</option>
                        <option value="4">4æœ¬ (0.63)</option>
                        <option value="6">5ã€œ6æœ¬ (0.56)</option>
                    </select>
                </div>
            </div>
            <div class="grid-2" style="margin-top:10px;">
                <div>
                    <label>ç®¡ç¨®åˆ¥</label>
                    <select id="conduit-cat" onchange="updateConduitSizes()">
                        <option value="G">åšé‹¼ (G)</option>
                        <option value="C">è–„é‹¼ (C)</option>
                        <option value="E">ã­ã˜ãªã— (E)</option>
                        <option value="PF">PFç®¡</option>
                        <option value="CD">CDç®¡ (åŸ‹è¾¼)</option>
                    </select>
                </div>
                <div>
                    <label>å‘¼ã³å¾„</label>
                    <select id="conduit-size" onchange="calculate()"></select>
                </div>
            </div>
        </div>

        <h2>4. é®æ–­å™¨å®šæ ¼ (AT)</h2>
        <div class="input-group">
            <label>ä¿è­·é®æ–­å™¨</label>
            <select id="breaker-at" onchange="calculate()"></select>
        </div>

        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ è¨­è¨ˆè¨ˆç®—æ›¸ã‚’å‡ºåŠ›</button>
    </div>

    <div class="card">
        <h1>ğŸ“Š è¨­è¨ˆè¨ˆç®—ãƒ»åˆ¤å®šçµæœ</h1>
        <div id="status-banner" class="status-banner">åˆ¤å®šä¸­...</div>

        <div class="result-grid">
            <div class="stat-card">
                <span class="stat-label">è² è·é›»æµ (I)</span>
                <span class="stat-value" id="res-calc-a">0.00 A</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">è£œæ­£å¾Œè¨±å®¹é›»æµ (Iz)</span>
                <span class="stat-value" id="res-limit-a">0.0 A</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">é›»åœ§é™ä¸‹ç‡ (Î”V)</span>
                <span class="stat-value" id="res-v-rate">0.0 %</span>
            </div>
            <div class="stat-card fill">
                <span class="stat-label">é…ç®¡å æœ‰ç‡ (ç›®æ¨™32%)</span>
                <span class="stat-value" id="res-fill-rate">0.0 %</span>
            </div>
            <div class="stat-card ground">
                <span class="stat-label">è‡ªå‹•é¸å®šæ¥åœ°ç·š (E)</span>
                <span class="stat-value" id="res-ground-size">-</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">é…ç®¡å†…æ–­é¢ç©</span>
                <span class="stat-value" id="res-conduit-area">0 mmÂ²</span>
            </div>
        </div>

        <div class="evidence-box">
            <h2>ğŸ“‹ æŠ€è¡“åˆ¤å®šãƒ»ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹</h2>
            <div id="evidence-list" style="font-weight: bold; min-height: 50px;"></div>
            <h2>ğŸ§® è¨ˆç®—ãƒ—ãƒ­ã‚»ã‚¹è©³ç´°</h2>
            <div id="formula-process" class="formula-box"></div>
        </div>
    </div>
</div>

<!-- è¨­è¨ˆæ ¹æ‹ ã‚¿ãƒ– -->
<div id="spec-view" class="card" style="display:none; margin: 20px auto; max-width: 1400px;">
    <h1>ğŸ“˜ JISè¦æ ¼ãƒ»å†…ç·šè¦ç¨‹ è¨­è¨ˆåŸºæº–ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹</h1>
    
    <div class="spec-item">
        <h3>1. é›»ç·šãƒ»ã‚±ãƒ¼ãƒ–ãƒ«ã®ç¨®é¡ã¨JISè¦æ ¼ãƒ»ç‰¹æ€§</h3>
        <table class="spec-table">
            <thead>
                <tr><th>ç·šç¨®åç§° (ã‚¨ã‚³åç§°)</th><th>JISè¦æ ¼</th><th>ç”¨é€”</th><th>é•·æ‰€ãƒ»ãƒ¡ãƒªãƒƒãƒˆ</th><th>çŸ­æ‰€ãƒ»æ³¨æ„ç‚¹</th></tr>
            </thead>
            <tbody>
                <tr><td>IV (EM-IE)</td><td>JIS C 3307</td><td>ä¸€èˆ¬å±‹å†…é…ç·šã€åˆ¶å¾¡ç›¤</td><td>å®‰ä¾¡ã€æ‘©æ“¦ãŒå°‘ãªãé…ç®¡æŒ¿å…¥ãŒå®¹æ˜“</td><td>ã‚·ãƒ¼ã‚¹ãŒãªã„ãŸã‚éœ²å‡ºä¸å¯ã€è€ç†±30â„ƒ</td></tr>
                <tr><td>HIV (EM-IC)</td><td>JIS C 3317</td><td>æ¶ˆé˜²è¨­å‚™ã€éå¸¸ç…§æ˜</td><td>è€ç†±75â„ƒã¨é«˜ãã€IVã‚ˆã‚Šè¨±å®¹é›»æµãŒå¤§</td><td>IVã«æ¯”ã¹é«˜ä¾¡ã€åŒã˜ãå˜ä½“éœ²å‡ºä¸å¯</td></tr>
                <tr><td>CV (EM-CE)</td><td>JIS C 3605</td><td>å‹•åŠ›å¹¹ç·šã€ä¸€èˆ¬å¹¹ç·š</td><td>çµ¶ç¸ä½“(æ¶æ©‹PE)ãŒç†±ã«å¼·ãã€é«˜è¨±å®¹é›»æµ</td><td>æ›²ã’åŠå¾„ã®ç¢ºä¿ãŒå¿…è¦ã€ç«¯æœ«å‡¦ç†ã«æ‰‹é–“</td></tr>
                <tr><td>CVT (EM-CET)</td><td>JIS C 3605</td><td>ä¸»å¹¹ç·šã€å¤§è¦æ¨¡ãƒ“ãƒ«</td><td>å˜å¿ƒã‚’æ’šã£ã¦ã„ã‚‹ãŸã‚æ”¾ç†±ãŒè‰¯ãè¨±å®¹é›»æµæœ€å¤§</td><td>ä»•ä¸Šå¤–å¾„ãŒå¤ªãã€é…ç®¡ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚‹</td></tr>
                <tr><td>VVF (EM-EEF)</td><td>JIS C 3342</td><td>ä½å®…ãƒ»åº—èˆ—ã®åˆ†å²å›è·¯</td><td>å¹³å‹ã§æ–½å·¥æ€§ãŒæ¥µã‚ã¦é«˜ã„ã€å¤©äº•è£ã“ã‚ãŒã—å¯</td><td>è¨±å®¹é›»æµãŒä½ãã€ç‰©ç†çš„è¡æ’ƒã«å¼±ã„</td></tr>
            </tbody>
        </table>
    </div>

    <div class="spec-item">
        <h3>2. é›»ç·šç®¡ï¼ˆé…ç®¡ï¼‰ã®ç¨®é¡ã¨ç‰¹æ€§æ¯”è¼ƒ</h3>
        <table class="spec-table">
            <thead>
                <tr><th>ç®¡ç¨®ç•¥ç§°</th><th>JISè¦æ ¼</th><th>åç§°</th><th>ä¸»ãªç”¨é€”</th><th>é•·æ‰€ãƒ»çŸ­æ‰€</th></tr>
            </thead>
            <tbody>
                <tr><td>Gç®¡</td><td>JIS C 8305</td><td>åšé‹¼é›»ç·šç®¡</td><td>å·¥å ´ã€å±‹å¤–ã€ç‰©ç†çš„è¡æ’ƒå ´æ‰€</td><td>æœ€é«˜å¼·åº¦ã€é›»ç£ã‚·ãƒ¼ãƒ«ãƒ‰ã€‚é‡ããƒã‚¸åˆ‡ã‚ŠãŒå¿…è¦ã€‚</td></tr>
                <tr><td>Cç®¡</td><td>JIS C 8330</td><td>è–„é‹¼é›»ç·šç®¡</td><td>ä¸€èˆ¬çš„ãªå±‹å†…é…ç®¡ã€å¤©äº•è£</td><td>Gç®¡ã‚ˆã‚Šè»½é‡ã€‚ãƒã‚¸åˆ‡ã‚Šæ–½å·¥ãŒå¿…è¦ã€‚</td></tr>
                <tr><td>Eç®¡</td><td>JIS C 8305</td><td>ã­ã˜ãªã—é›»ç·šç®¡</td><td>ãƒ“ãƒ«ã€åº—èˆ—ã®å±‹å†…éœ²å‡ºãƒ»éš è”½</td><td>ãƒã‚¸åˆ‡ã‚Šä¸è¦ã§æ–½å·¥ãŒæ—©ã„ã€‚å¼·åº¦ã¯G/Cã«åŠ£ã‚‹ã€‚</td></tr>
                <tr><td>PFç®¡</td><td>JIS C 8411</td><td>åˆæˆæ¨¹è„‚è£½å¯ã¨ã†ç®¡</td><td>äºŒé‡å¤©äº•å†…ã€éš è”½ãƒ»éœ²å‡º</td><td>è‡ªå·±æ¶ˆç«æ€§ãŒã‚ã‚Šéœ²å‡ºå¯ã€‚æ›²ã’ãŒæ¥µã‚ã¦å®¹æ˜“ã€‚</td></tr>
                <tr><td>CDç®¡</td><td>JIS C 8411</td><td>åˆæˆæ¨¹è„‚è£½å¯ã¨ã†ç®¡</td><td>ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆåŸ‹è¾¼å°‚ç”¨</td><td>å®‰ä¾¡ã€è»½é‡ã€‚**éè€ç‡ƒæ€§ã®ãŸã‚éœ²å‡ºé…ç·šã¯ç¦æ­¢ã€‚**</td></tr>
            </tbody>
        </table>
    </div>

    <div class="spec-item">
        <h3>3. å†…ç·šè¦ç¨‹ï¼ˆJEAC 8001ï¼‰ã«åŸºã¥ãè¨ˆç®—æ¡ä»¶</h3>
        <ul>
            <li><strong>é…ç®¡å æœ‰ç‡:</strong> 3102-3ç¯€ã€‚ç•°ãªã‚‹å¤ªã•åå®¹æ™‚32%ä»¥ä¸‹ã€‚åŒä¸€å¤ªã•48%ä»¥ä¸‹ã€‚æœ¬ã‚¢ãƒ—ãƒªã¯å®‰å…¨å´ã®32%ã‚’åŸºæº–ã€‚</li>
            <li><strong>é›»åœ§é™ä¸‹:</strong> 1310-1ç¯€ã€‚åˆ†å²å›è·¯ã¯2%ä»¥å†…ã€å¤‰åœ§å™¨ã‹ã‚‰å…¨ä½“ã§3%ä»¥å†…ã‚’æ¨å¥¨ã€‚</li>
            <li><strong>ä¸¦åˆ—æ¥ç¶š:</strong> 1360-11ç¯€ã€‚è¨±å®¹é›»æµã«0.88ã‚’ä¹—ç®—ã€‚åŒä¸€ç·šç¨®ã€åŒä¸€ã‚µã‚¤ã‚ºã€åŒä¸€é•·ã•ã§ã‚ã‚‹ã“ã¨ã€‚</li>
            <li><strong>æ¸©åº¦è£œæ­£:</strong> 3103-2è¡¨ã€‚åŸºæº–30â„ƒã«å¯¾ã—ã€40â„ƒ(0.82)ã€50â„ƒ(0.58)ã‚’é©ç”¨ã€‚</li>
        </ul>
    </div>
</div>

<script>
let currentMode = 'kW';
let activeTab = 'branch';

// é›»ç·šDB
const db = {
    "IV (EM-IE) / HIV (EM-IC)": [
        {s:"1.6mm", a:27, r:8.92, area:7.1}, {s:"2.0mm", a:35, r:5.65, area:9.1}, {s:"2.6mm", a:48, r:3.35, area:15.2},
        {s:"5.5SQ", a:49, r:3.33, area:19.6}, {s:"8SQ", a:61, r:2.31, area:28.3}, {s:"14SQ", a:88, r:1.30, area:45.4},
        {s:"22SQ", a:115, r:0.824, area:67.9}, {s:"38SQ", a:162, r:0.487, area:104}, {s:"60SQ", a:217, r:0.303, area:163},
        {s:"100SQ", a:298, r:0.180, area:254}, {s:"150SQ", a:395, r:0.118, area:380}, {s:"200SQ", a:469, r:0.091, area:491},
        {s:"250SQ", a:556, r:0.072, area:616}, {s:"325SQ", a:650, r:0.056, area:755}
    ],
    "CV (EM-CE) / CVT (EM-CET)": [
        {s:"2SQ", a:20, r:9.42, area:113}, {s:"3.5SQ", a:27, r:5.38, area:132}, {s:"5.5SQ", a:36, r:3.42, area:154},
        {s:"8SQ", a:45, r:2.35, area:201}, {s:"14SQ", a:64, r:1.34, area:314}, {s:"22SQ", a:87, r:0.85, area:452},
        {s:"38SQ", a:120, r:0.49, area:660}, {s:"60SQ", a:160, r:0.31, area:907}, {s:"100SQ", a:220, r:0.18, area:1385},
        {s:"150SQ", a:290, r:0.12, area:1963}, {s:"200SQ", a:345, r:0.09, area:2551}, {s:"250SQ", a:400, r:0.07, area:3117}, {s:"325SQ", a:475, r:0.06, area:3848}
    ],
    "VVF (EM-EEF)": [
        {s:"1.6mm-2C", a:18, r:8.92, area:100}, {s:"1.6mm-3C", a:15, r:8.92, area:110},
        {s:"2.0mm-2C", a:23, r:5.65, area:120}, {s:"2.0mm-3C", a:20, r:5.65, area:140}
    ]
};

const groundingDb = [
    {at: 20, size: "1.6mm", area:7.1}, {at: 30, size: "2.0mm", area:9.1}, {at: 60, size: "5.5SQ", area:19.6},
    {at: 100, size: "8SQ", area:28.3}, {at: 225, size: "14SQ", area:45.4}, {at: 400, size: "22SQ", area:67.9},
    {at: 600, size: "60SQ", area:163}, {at: 1000, size: "100SQ", area:254}
];

const conduitData = {
    "G": { "16":211, "22":366, "28":607, "36":957, "42":1333, "54":2198, "70":3495, "82":4791, "92":6027, "104":7806 },
    "C": { "19":257, "25":445, "31":716, "39":1122, "51":1893, "63":2951, "75":4266 },
    "E": { "19":281, "25":487, "31":774, "39":1195, "51":1995, "63":3088, "75":4441 },
    "PF": { "14":154, "16":201, "22":380, "28":616, "36":1018, "42":1385, "54":2290 },
    "CD": { "14":154, "16":201, "22":380, "28":616, "36":1018, "42":1385, "54":2290 }
};

const sysOptions = [
    {v:"12-100", t:"å˜ç›¸2ç·š 100V", cores:2, f:2},
    {v:"13-200", t:"å˜ç›¸3ç·š 200/100V", cores:2, f:1},
    {v:"33-200", t:"ä¸‰ç›¸3ç·š 200V", cores:3, f:1.732},
    {v:"34-400", t:"ä¸‰ç›¸4ç·š 400V/230V", cores:4, f:1}
];

function switchTab(tab) {
    activeTab = tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    document.getElementById('calc-view').style.display = tab === 'branch' ? 'grid' : 'none';
    document.getElementById('spec-view').style.display = tab === 'spec' ? 'block' : 'none';
}

function init() {
    const s1 = document.getElementById('sys-type');
    sysOptions.forEach(o => s1.add(new Option(o.t, o.v)));
    const s2 = document.getElementById('wire-cat');
    for(let k in db) s2.add(new Option(k, k));
    const s3 = document.getElementById('breaker-at');
    [15, 20, 30, 40, 50, 60, 75, 100, 125, 150, 175, 200, 225, 250, 300, 350, 400, 500, 600, 800, 1000].forEach(a => s3.add(new Option(a + " A", a)));
    s3.value = 20;
    updateSizes();
    updateConduitSizes();
}

function syncLength(val, origin) {
    const v = parseFloat(val);
    if (origin === 'range') document.getElementById('length-num').value = v;
    else document.getElementById('length-range').value = v;
    document.getElementById('val-length').innerText = v;
    calculate();
}

function updateSizes() {
    const cat = document.getElementById('wire-cat').value;
    const sel = document.getElementById('wire-size');
    sel.innerHTML = '';
    db[cat].forEach((v, i) => sel.add(new Option(v.s, i)));
    calculate();
}

function updateConduitSizes() {
    const cat = document.getElementById('conduit-cat').value;
    const sel = document.getElementById('conduit-size');
    sel.innerHTML = '';
    for(let k in conduitData[cat]) sel.add(new Option(cat + k, k));
    calculate();
}

function setMode(m) {
    currentMode = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + m).classList.add('active');
    calculate();
}

function calculate() {
    const sys = sysOptions[document.getElementById('sys-type').selectedIndex];
    const rawInput = parseFloat(document.getElementById('main-input').value) || 0;
    const pf_d = parseFloat(document.getElementById('pf-percent').value) / 100;
    const length = parseFloat(document.getElementById('length-num').value);
    const breakerAT = parseFloat(document.getElementById('breaker-at').value);
    const cat = document.getElementById('wire-cat').value;
    const wire = db[cat][document.getElementById('wire-size').value];
    const parallelN = parseInt(document.getElementById('parallel-n').value);
    const k_temp = { 30:1.0, 40:0.82, 50:0.58 }[document.getElementById('temp').value];
    const k_bundle = { 1:1.0, 3:0.7, 4:0.63, 6:0.56 }[document.getElementById('bundle').value];
    const k_parallel = parallelN > 1 ? 0.88 : 1.0; 

    // 1. è² è·é›»æµ (I) è¨ˆç®—
    let v_calc = parseInt(sys.v.split('-')[1]);
    let I = 0;
    if (currentMode === 'A') {
        I = rawInput;
    } else {
        let w = currentMode === 'kW' ? rawInput * 1000 : rawInput;
        let denom = (sys.v.startsWith('3') ? 1.732 : 1) * v_calc * pf_d;
        I = denom !== 0 ? w / denom : 0;
    }
    document.getElementById('res-calc-a').innerText = I.toFixed(2) + " A";

    // 2. è£œæ­£å¾Œè¨±å®¹é›»æµ (Iz)
    const Iz = wire.a * k_temp * k_bundle * parallelN * k_parallel;
    document.getElementById('res-limit-a').innerText = Iz.toFixed(1) + " A";

    // 3. é›»åœ§é™ä¸‹ç‡
    const vRate = ((sys.f * length * I * (wire.r / parallelN)) / 1000 / v_calc) * 100;
    document.getElementById('res-v-rate').innerText = vRate.toFixed(2) + " %";

    // 4. æ¥åœ°ç·šã‚µã‚¤ã‚º & å æœ‰ç‡
    const gObj = groundingDb.find(item => item.at >= breakerAT) || groundingDb[groundingDb.length-1];
    document.getElementById('res-ground-size').innerText = gObj.size;

    let wireArea = (cat.includes("CV") || cat.includes("VVF")) ? (wire.area * parallelN) : (wire.area * sys.cores * parallelN);
    wireArea += gObj.area; 
    
    const pipeArea = conduitData[document.getElementById('conduit-cat').value][document.getElementById('conduit-size').value];
    const fillRate = (wireArea / pipeArea) * 100;
    document.getElementById('res-fill-rate').innerText = fillRate.toFixed(1) + " %";
    document.getElementById('res-conduit-area').innerText = pipeArea + " mmÂ²";

    // 5. åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
    const list = document.getElementById('evidence-list');
    const banner = document.getElementById('status-banner');
    let logs = []; let status = "safe";

    if (I > breakerAT) { logs.push("âŒ è² è·éå¤§: ãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼å®šæ ¼(AT)ä¸è¶³"); status = "danger"; }
    if (breakerAT > Iz) { logs.push("âŒ ä¿è­·ä¸é©åˆ: é®æ–­å™¨å®šæ ¼(AT)ãŒè¨±å®¹é›»æµ(Iz)ã‚’è¶…é"); status = "danger"; }
    if (vRate > 2.0) { 
        let c = vRate > 3.0 ? "âŒ" : "âš ï¸";
        logs.push(`${c} é›»åœ§é™ä¸‹: ${vRate.toFixed(1)}% (2%ä»¥å†…æ¨å¥¨)`);
        if(status!=="danger") status = vRate > 3.0 ? "danger" : "warn";
    }
    if (fillRate > 32.0) { logs.push("âš ï¸ é…ç®¡å æœ‰ç‡: 32%è¶…é (å†…ç·šè¦ç¨‹æ³¨æ„)"); if(status!=="danger") status="warn"; }
    if (document.getElementById('conduit-cat').value === "CD") logs.push("â„¹ï¸ CDç®¡: åŸ‹è¾¼å°‚ç”¨ã€‚éœ²å‡ºæ–½å·¥ç¦æ­¢ã€‚");

    list.innerHTML = logs.length ? logs.join("<br>") : "âœ… ä¿è­·å”èª¿ãŠã‚ˆã³å…¨ã¦ã®åŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™";
    banner.className = "status-banner " + status;
    banner.innerText = status === "safe" ? "âœ… è¨­è¨ˆé©æ­£" : (status === "warn" ? "âš ï¸ è¨­è¨ˆæ³¨æ„" : "âŒ è¨­è¨ˆä¸é©åˆ");

    document.getElementById('formula-process').innerHTML = 
        `è² è·é›»æµ I: ${I.toFixed(2)}A | é®æ–­å™¨ In: ${breakerAT}A | è¨±å®¹é›»æµ Iz: ${Iz.toFixed(1)}A<br>` +
        `ä¿è­·æ¡ä»¶: I â‰¦ AT â‰¦ Iz (${I.toFixed(1)} â‰¦ ${breakerAT} â‰¦ ${Iz.toFixed(1)})<br>` +
        `å æœ‰ç‡: (${wireArea.toFixed(1)} / ${pipeArea}) = ${fillRate.toFixed(1)}%`;
}

init();
</script>
</body>
</html>
